apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    {{- include "uvarc-unified-service.labels" . | nindent 4 }}
  name: {{ include "uvarc-unified-service.fullname" . }}-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "uvarc-unified-service.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "uvarc-unified-service.selectorLabels" . | nindent 8 }}
    spec:
      volumes:
      - name: {{ include "uvarc-unified-service.fullname" . }}-ceph-data
        persistentVolumeClaim:
          claimName: {{ include "uvarc-unified-service.fullname" . }}-ceph-pvc-data

      containers:
      - image: "ghcr.io/uvarc/uvarc-unified-service:develop"
      #- image: "quay.io/accord/accord-service:develop"
        name: uvarc-unified-service
        imagePullPolicy: "Always"
        command:
        - /usr/bin/supervisord

        volumeMounts:
        - name: {{ include "uvarc-unified-service.fullname" . }}-ceph-data
          mountPath: /opt/local/non_root_user/uvarc_unified_service/data/

        resources:
          requests:
            memory: "1524Mi"
            cpu: "1000m"
          limits:
            memory: "2024Mi"
            cpu: "1500m"
        envFrom:
        - configMapRef:
            name: {{ include "uvarc-unified-service.fullname" . }}-configmap
        env:
        - name: JIRA_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: JIRA_CLIENT_ID

        - name: JIRA_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: JIRA_CLIENT_SECRET

        - name: WORKDAY_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: WORKDAY_CLIENT_ID

        - name: WORKDAY_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: WORKDAY_CLIENT_SECRET

        - name: SMTP_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: SMTP_CLIENT_ID

        - name: SMTP_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: SMTP_CLIENT_SECRET

        - name: AWS_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: AWS_CLIENT_ID

        - name: AWS_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: AWS_CLIENT_SECRET

        - name: MONGO_USER
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: MONGO_USER

        - name: MONGO_PASSWORD
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: MONGO_PASSWORD

        - name: LDAP_PUBLIC_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: LDAP_PUBLIC_CLIENT_ID

        - name: LDAP_PUBLIC_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: LDAP_PUBLIC_CLIENT_SECRET

        - name: LDAP_PRIVATE_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: LDAP_PRIVATE_CLIENT_ID

        - name: LDAP_PRIVATE_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: LDAP_PRIVATE_CLIENT_SECRET

        - name: HPC_API_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: HPC_API_CLIENT_ID

        - name: HPC_API_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: uvarc-unified-service-secret
              key: HPC_API_CLIENT_SECRET